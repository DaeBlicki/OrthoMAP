#'-----------------------------------------------------------------------------
#' @title   Compare Configuration
#'
#' @concept
#' Compares the harmonized shannon entropy between clusters generated by the
#' OrthoMAP workflow in the fine-clustering. It compares PCA vs harmony, and
#' euclidean vs. cosine. The results must be in form of `csv` and must have
#' column `Shannon_Entropy`.
#'
#' @description
#' It calculates the boxplot for the two different methods. It uses the
#' concatenated results of all different inputs.
#'
#' @author  David Blickenstorfer, Technau Group (2025)
#' @created 16/08/2025
#'
#' Version: v1.0.0
#' Changelog:
#'  - v1.0.0: Initial release
#'
#' @copyright Technau Group, University of Vienna, 2025
#' @copyright Boeva Lab, ETH Zurich, 2025
#' ----------------------------------------------------------------------------
# Load library
library(tidyverse)
color_vector <- c(
  "OMA" = "#f06180",
  "HOG [mmseqs2]" = "#54bae9",
  "HOG [diamond]" = "#c588eb",
  "OOG [mmseqs2]" = "#7bd47b",
  "OOG [diamond]" = "#dbdb81"
)
methodnames <- c("OMA", "HOG [mmseqs2]", "HOG [diamond]",
                 "OOG [mmseqs2]", "OOG [diamond]")
# -----------------------------------------------------------------------------
# Step 1: Load Data and Preparation
# -----------------------------------------------------------------------------
result_path <- file.path("results", "OrthoMAP_Statistical_Results")
pca_path <- c(
  file.path(result_path, "oma", "3", "local_statistic.csv"),
  file.path(result_path, "mmseqs2", "HOG", "3", "local_statistic.csv"),
  file.path(result_path, "diamond", "HOG", "3", "local_statistic.csv"),
  file.path(result_path, "mmseqs2", "OOG", "3", "local_statistic.csv"),
  file.path(result_path, "diamond", "OOG", "3", "local_statistic.csv")
)
harmony_path <- c(
  file.path(result_path, "oma", "4", "local_statistic.csv"),
  file.path(result_path, "mmseqs2", "HOG", "4", "local_statistic.csv"),
  file.path(result_path, "diamond", "HOG", "4", "local_statistic.csv"),
  file.path(result_path, "mmseqs2", "OOG", "4", "local_statistic.csv"),
  file.path(result_path, "diamond", "OOG", "4", "local_statistic.csv")
)
euclidean_path <- c(
  file.path(result_path, "oma", "5", "local_statistic.csv"),
  file.path(result_path, "mmseqs2", "HOG", "5", "local_statistic.csv"),
  file.path(result_path, "diamond", "HOG", "5", "local_statistic.csv"),
  file.path(result_path, "mmseqs2", "OOG", "5", "local_statistic.csv"),
  file.path(result_path, "diamond", "OOG", "5", "local_statistic.csv")
)

# -----------------------------------------------------------------------------
# Step 2: Create Entropy Table
# -----------------------------------------------------------------------------
pca_entropy_list <- mapply(function(file, method) {
  entropy <- read.csv(file = file)$Shannon_Entropy
  method <- rep(method, length(entropy))
  data.frame(method = method, entropy = entropy)
}, pca_path, methodnames, SIMPLIFY = FALSE)
pca_table <- do.call(rbind, pca_entropy_list)
rownames(pca_table) <- NULL
pca_table$annoy.metric <- "cosine"
pca_table$reduction <- "pca"

harmony_entropy_list <- mapply(function(file, method) {
  entropy <- read.csv(file = file)$Shannon_Entropy
  method <- rep(method, length(entropy))
  data.frame(method = method, entropy = entropy)
}, harmony_path, methodnames, SIMPLIFY = FALSE)
harmony_table <- do.call(rbind, harmony_entropy_list)
rownames(harmony_table) <- NULL
harmony_table$annoy.metric <- "cosine"
harmony_table$reduction <- "harmony"

euclidean_entropy_list <- mapply(function(file, method) {
  entropy <- read.csv(file = file)$Shannon_Entropy
  method <- rep(method, length(entropy))
  data.frame(method = method, entropy = entropy)
}, euclidean_path, methodnames, SIMPLIFY = FALSE)
euclidean_table <- do.call(rbind, euclidean_entropy_list)
rownames(euclidean_table) <- NULL
euclidean_table$annoy.metric <- "euclidean"
euclidean_table$reduction <- "pca"

df_long <- rbind(pca_table, harmony_table, euclidean_table)
df_long$condition <- interaction(df_long$reduction,
                                 df_long$annoy.metric, sep = "-")
df_long$method <- factor(df_long$method,
                         levels = unique(df_long$method))
df_long$reduction <- factor(df_long$reduction,
                            levels = unique(df_long$reduction))
df_long$annoy.metric <- factor(df_long$annoy.metric,
                               levels = unique(df_long$annoy.metric))
df_long$condition <- factor(df_long$condition,
                            levels = unique(df_long$condition))
rm(pca_table, harmony_table, methodnames, pca_path, harmony_path)
# boxplot for mean and median
plot <- ggplot2::ggplot(df_long, aes(x=condition, y=entropy,
                                     color=method, fill=method)) +
  ggplot2::geom_boxplot(alpha=0.5, width = 0.6,
                        outlier.shape = 21, outlier.size = 2) +
  ggplot2::scale_color_manual(values = color_vector) +
  ggplot2::scale_fill_manual(values = color_vector) +
  ggplot2::labs(y = "Harmonized Shannon Entropy") +
  ggplot2::geom_jitter(shape=16, position=position_jitter(0.2)) +
  ggplot2::theme_bw() + ggplot2::theme(axis.title.x = ggplot2::element_blank())

plotname <- file.path("results", "benchmark", "configuration_entropy.pdf")
ggplot2::ggsave(plotname, plot, width = 12, height = 8)